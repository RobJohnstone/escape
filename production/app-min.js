!function(a,b){b["true"]=a;var c={};c.instances=[],c.process=function(){for(var a=[],b=0;b<c.instances.length;b++)c.instances[b].process(),c.instances[b].remove||a.push(c.instances[b]);c.instances=a},c.render=function(){for(var a=0;a<c.instances.length;a++)c.instances[a].render()};var d={hittable:!1,init:function(){if(void 0===a)var a=0;return function(b){return $.extend(this,b),this.entityId=a++,this.halfWidth=this.width/2,this.halfHeight=this.height/2,c.instances.push(this),this}}(),process:function(){}},e=Object.create(d);e.entityType="actor",e.hittable=!0,e.health=100,e.weapon="gun",e.move=function(a){var b,c=l.getTileIndex(this),d=c-1,e=c-l.columns,f=c+1,g=c+l.columns,h=e-1,i=e+1,j=g+1,k=g-1,m=!1;return a=p.setLength(a,this.speed*o.coeff),b=p.add(this,a),b.x-this.halfWidth<0&&(b.x=this.halfWidth),b.x+this.halfWidth>l.width&&(b.x=l.width-this.halfWidth),b.y-this.halfHeight<0&&(b.y=this.halfHeight),b.y+this.halfHeight>l.height&&(b.y=l.height-this.halfHeight),a.x<0&&b.x-this.halfWidth<c%l.columns*n.tileWidth?void 0===l.data[d]||n.tileset[l.data[d]].passable?void 0!==l.data[h]&&!n.tileset[l.data[h]].passable&&b.y-this.halfHeight<Math.floor(c/l.rows)*n.tileHeight?b.y=this.halfHeight+Math.floor(c/l.rows)*n.tileHeight:void 0!==l.data[k]&&!n.tileset[l.data[k]].passable&&b.y+this.halfHeight>Math.floor(g/l.rows)*n.tileHeight&&(b.y=-this.halfHeight+Math.floor(g/l.rows)*n.tileHeight):(b.x=this.halfWidth+c%l.columns*n.tileWidth,b.y=this.y+(a.y?a.y/Math.abs(a.y):0)*Math.round(this.speed*o.coeff)):a.x>0&&b.x+this.halfWidth>f%l.columns*n.tileWidth&&(void 0===l.data[f]||n.tileset[l.data[f]].passable?void 0!==l.data[i]&&!n.tileset[l.data[i]].passable&&b.y-this.halfHeight<Math.floor(c/l.rows)*n.tileHeight?b.y=this.halfHeight+Math.floor(c/l.rows)*n.tileHeight:void 0!==l.data[j]&&!n.tileset[l.data[j]].passable&&b.y+this.halfHeight>Math.floor(g/l.rows)*n.tileHeight&&(b.y=-this.halfHeight+Math.floor(g/l.rows)*n.tileHeight):(b.x=-this.halfWidth+f%l.columns*n.tileWidth,b.y=this.y+(a.y?a.y/Math.abs(a.y):0)*Math.round(this.speed*o.coeff))),a.y<0&&b.y-this.halfHeight<Math.floor(c/l.rows)*n.tileHeight?void 0===l.data[e]||n.tileset[l.data[e]].passable?void 0!==l.data[h]&&!n.tileset[l.data[h]].passable&&b.x-this.halfWidth<Math.floor(c%l.columns)*n.tileWidth?b.x=this.halfWidth+Math.floor(c%l.columns)*n.tileWidth:void 0!==l.data[i]&&!n.tileset[l.data[i]].passable&&b.x+this.halfWidth>Math.floor(f%l.columns)*n.tileWidth&&(b.x=-this.halfWidth+Math.floor(f%l.columns)*n.tileWidth):(b.y=this.halfHeight+Math.floor(c/l.rows)*n.tileHeight,b.x=this.x+(a.x?a.x/Math.abs(a.x):0)*Math.round(this.speed*o.coeff)):a.y>0&&b.y+this.halfHeight>Math.floor(g/l.rows)*n.tileHeight&&(void 0===l.data[g]||n.tileset[l.data[g]].passable?void 0!==l.data[k]&&!n.tileset[l.data[k]].passable&&b.x-this.halfWidth<Math.floor(c%l.columns)*n.tileWidth?b.x=this.halfWidth+Math.floor(c%l.columns)*n.tileWidth:void 0!==l.data[j]&&!n.tileset[l.data[j]].passable&&b.x+this.halfWidth>Math.floor(f%l.columns)*n.tileWidth&&(b.x=-this.halfWidth+Math.floor(f%l.columns)*n.tileWidth):(b.y=-this.halfHeight+Math.floor(g/l.rows)*n.tileHeight,b.x=this.x+(a.x?a.x/Math.abs(a.x):0)*Math.round(this.speed*o.coeff))),this.direction=p.normalise(p.subtract(this,b)),this.x===b.x&&this.y===b.y&&(m=!0),this.x=Math.round(b.x),this.y=Math.round(b.y),!m},e.moveTowards=function(a){var b=p.subtract(this,a);b=p.setLength(b,this.speed),this.move(b)},e.moveTo=function(a){var b=l.getTileCoords(l.getTileIndex(this)),c=l.getTileCoords(l.getTileIndex(a)),d=k(l.pathGrid,b,c,"Euclidean");d.length>1?this.moveTowards(l.getTileCentre(d[1])):1===d.length&&this.moveTowards(l.getTileCentre(d[0]))},e.hit=function(a){this.invulnerable||(this.health-=a.damage,this.health<=0&&(this.remove=!0)),"function"==typeof this.hitHandler&&this.hitHandler(a)},e.fire=function(a){var b,c=q[this.weapon],d=c.projectileSpeed,e=p.subtract(this,a),f=p.setLength(e,d),g=this;(void 0===this.lastFired||this.lastFired<o.time-c.reloadTime)&&(b=Object.create(m),b.init({x:this.x,y:this.y,width:4,height:4,colour:"yellow",speed:f,firerId:g.entityId,damage:c.damage}),this.lastFired=o.time),this.direction=p.normalise(e)},e.render=function(){i.gameContext.save(),i.gameContext.translate(l.offset.x,l.offset.y),i.gameContext.translate(this.x,this.y),i.gameContext.rotate(-p.angle(this.direction,{x:0,y:-1},!0)),i.gameContext.beginPath(),i.gameContext.moveTo(-this.halfWidth,this.halfHeight),i.gameContext.lineTo(0,-this.halfHeight),i.gameContext.lineTo(this.halfWidth,this.halfHeight),i.gameContext.fillStyle=this.colour,i.gameContext.fill(),i.gameContext.restore(),i.writeText(this.health,this.x-this.halfWidth+l.offset.x,this.y+l.offset.y)};var f=Object.create(e);f.firerId=function(){var a=-1;return function(){return a++}()}(),f.target={x:0,y:0},f.process=function(){var a,b;if(player.health<=0)this.mode="watch";else switch(this.baddySeePlayer()&&(this.targetTile=l.getTileIndex(player),this.target=$.extend({},player,l.getTileCentre(this.targetTile)),this.target.direction=p.clone(player.direction),this.fire(player),this.mode=this.targetDistance>this.idealRange?"chase":"attack"),this.mode){case"watch":break;case"attack":this.direction=p.subtract(this,this.target),player.health>0&&!this.baddySeePlayer()&&(this.mode="chase");break;case"chase":a=p.distance(this,this.target),a<this.speed?(this.x=this.target.x,this.y=this.target.y,this.mode="search",this.direction=this.target.direction):this.moveTo(this.target);break;case"search":b=p.setLength(this.direction,this.speed),this.move(b)||(this.mode="returnToStation");break;case"returnToStation":a=p.distance(this,this.initial),a<this.speed?(this.x=this.initial.x,this.y=this.initial.y,this.mode="watch",this.direction=this.initial.direction):this.moveTo(this.initial)}},f.hitHandler=function(a){this.direction=p.reverse(a.speed)},f.baddySeePlayer=function(){var a=p.subtract(this,player);return p.mag(a)>this.maxRange||p.dot(this.direction,a)<0?!1:l.lineTraversable(this,player)};var g={create:function(a){var b=this[a.type];$.extend(b,a),b.initial=$.extend({},b),Object.create(b.prototype).init(b)},player:{prototype:e,width:32,height:32,colour:"green",speed:5,direction:{x:1,y:0},invulnerable:!1},baddy:{prototype:f,width:32,height:32,colour:"red",maxRange:500,mode:"watch",idealRange:500,speed:5,direction:{x:1,y:0}}},h={mode:"pause"};h.init=function(){i.init("fullscreen",""),l.load("test","",64,64,h.start)},h.start=function(){h.resume()},h.resume=function(){h.mode="play",j.start("play"),o.start(60),h.animationFrame=window.requestAnimationFrame(h.play)},h.play=function(){"play"===h.mode||"over"===h.mode?(o.process(),c.process(),l.position(player),"over"===h.mode&&i.writeText("Game over!",20,30),h.info(),i.render(),j.process(),player.health<=0&&"play"===h.mode&&h.over(),h.animationFrame=window.requestAnimationFrame(h.play)):"pause"===h.mode&&(i.writeText("Game paused. Press space to resume.",20,30),i.renderText())},h.info=function(){i.writeText("FPS: "+Math.round(o.FPS),i.gameCanvas.width-150,30),i.writeText("map.offset.x: "+l.offset.x,i.gameCanvas.width-150,50),i.writeText("map.offset.y: "+l.offset.y,i.gameCanvas.width-150,70),i.writeText("player.x: "+player.x,i.gameCanvas.width-150,90),i.writeText("player.y: "+player.y,i.gameCanvas.width-150,110),i.writeText("player.direction.x: "+player.direction.x,i.gameCanvas.width-150,130),i.writeText("player.direction.y: "+player.direction.y,i.gameCanvas.width-150,150),i.writeText("player.direction angle: "+p.angle(player.direction),i.gameCanvas.width-200,170),i.writeText("tile index: "+l.getTileIndex(player),i.gameCanvas.width-150,190)},h.pause=function(){h.mode="pause",j.start("pause"),i.renderText()},h.over=function(){h.mode="over",j.start("over")},h.reset=function(){c.instances=[],cancelAnimationFrame(h.animationFrame),h.init()},h.end=function(){h.pause(),j.stop()},$(function(){h.init()});var i={};i.init=function(a,b,c){$("#gameContainer").html(""),i.viewport={width:$("#gameContainer").width(),height:$("#gameContainer").height()},"fullscreen"===a&&(i.fullscreen=!0,a=i.viewport.width,b=i.viewport.height),i.initCanvas("game",a,b),i.clipping=void 0===c?!0:c},i.initCanvas=function(a,b,c){b||(b=800),c||(c=600),$("#gameContainer").append('<canvas id="'+a+'Canvas" class="defaultBorder" width="'+b+'px" height="'+c+'px">Your broswer does not support the "canvas element". To play this game you will need a more modern browser.</canvas>'),$("#"+a+"Canvas").css({width:+b+"px",height:c+"px"}),i[a+"Canvas"]=document.getElementById(a+"Canvas"),i[a+"Context"]=i.gameCanvas.getContext("2d"),i[a+"Canvas"].width=b,i[a+"Canvas"].height=c},i.textQueue=[],i.writeText=function(a,b,c){i.textQueue.push({string:a,x:b,y:c})},i.writeTextNow=function(a,b,c){var d=i.gameContext.fillStyle,e=i.gameContext.strokeStyle,f=i.gameContext.font;i.gameContext.fillStyle="white",i.gameContext.strokeStyle="black",i.gameContext.font="12pt Arial",i.gameContext.strokeText(a,b,c),i.gameContext.fillText(a,b,c),i.gameContext.fillStyle=d,i.gameContext.strokeStyle=e,i.gameContext.font=f},i.renderText=function(){i.textQueue.forEach(function(a){i.writeTextNow(a.string,a.x,a.y)}),i.textQueue=[]},i.vectors={commands:[],render:function(){for(var a=0;a<this.commands.length;a++)this.commands[a]();this.commands=[]},command:function(a){this.commands.push(a)}},i.render=function(){i.clipping?i.gameContext.clearRect(-l.offset.x,-l.offset.y,i.gameCanvas.width,i.gameCanvas.height):i.gameContext.clearRect(-l.offset.x,-l.offset.y,i.viewport.width,i.viewport.height),l.render(),c.render(),i.vectors.render(),i.renderText()},i.resizeCanvas=function(a,b,c){i[a+"Canvas"].width=b,i[a+"Canvas"].height=c,$("#"+a+"Canvas").css({width:+b+"px",height:c+"px"})};var j={};j.keyMap={80:"pause",27:"quit",65:"left",87:"up",68:"right",83:"down",73:"invulnerable"},j.start=function(a){switch($(document).off(),a){case"play":j.keyState={pause:0,quit:0,left:0,up:0,right:0,down:0},$(document).on("keydown keyup",function(a){var b=""+a.which;return void 0!==j.keyMap[b]?("invulnerable"===j.keyMap[b]&&"keydown"===a.type&&(player.invulnerable=!player.invulnerable),j.keyState[j.keyMap[b]]="keydown"===a.type?1:0,!1):void 0}),j.mouseState={left:0,middle:0,right:0,x:0,y:0},$(document).on("mousedown mouseup",function(a){switch(a.which){case 1:j.mouseState.left="mousedown"===a.type?1:0;break;case 2:j.mouseState.middle="mousedown"===a.type?1:0;break;case 3:j.mouseState.right="mousedown"===a.type?1:0}}),$(document).on("mousemove",function(a){var b=$("#gameCanvas").offset();j.mouseState.x=a.pageX-b.left,j.mouseState.y=a.pageY-b.top});break;case"pause":$(document).off(),$(document).on("keydown",function(a){return 32===a.which&&h.resume(),!1});break;case"over":$(document).off(),$(document).on("keydown",function(a){return 32===a.which&&h.reset(),!1});break;case"edit":j.mouseState={left:0,middle:0,right:0,x:0,y:0},$(document).on("mousemove",function(a){var b=$("#gameCanvas").offset();j.mouseState.x=a.pageX-b.left,j.mouseState.y=a.pageY-b.top,h.update=!0})}},j.process=function(){switch(h.mode){case"play":j.keyState.pause&&h.pause(),j.keyState.quit&&(h.end(),i.writeText("Game ended.",20,30));var a=0,b=0;j.keyState.left&&(a+=-5),j.keyState.up&&(b+=-5),j.keyState.right&&(a+=5),j.keyState.down&&(b+=5),(0!==a||0!==b)&&player.move({x:a,y:b}),j.mouseState.left&&player.fire({x:j.mouseState.x-l.offset.x,y:j.mouseState.y-l.offset.y});break;case"edit":}},j.stop=function(){$(document).off()};var k=function(){function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return a&&(c&&!i[e][g]&&(l[m++]={x:g,y:e}),d&&!i[e][h]&&(l[m++]={x:h,y:e})),b&&(c&&!i[f][g]&&(l[m++]={x:g,y:f}),d&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function b(a,b,c,d,e,f,g,h,i,j,k,l,m){return a=e>-1,b=j>f,c=k>g,d=h>-1,c&&(a&&!i[e][g]&&(l[m++]={x:g,y:e}),b&&!i[f][g]&&(l[m++]={x:g,y:f})),d&&(a&&!i[e][h]&&(l[m++]={x:h,y:e}),b&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function c(a,b,c,d,e,f,g,h,i,j,k,l){return l}function d(a,b,c,d,e,f){var g=c-1,h=c+1,i=b+1,j=b-1,k=g>-1&&!d[g][b],l=e>h&&!d[h][b],m=f>i&&!d[c][i],n=j>-1&&!d[c][j],o=[],p=0;return k&&(o[p++]={x:b,y:g}),m&&(o[p++]={x:i,y:c}),l&&(o[p++]={x:b,y:h}),n&&(o[p++]={x:j,y:c}),a(k,l,m,n,g,h,i,j,d,e,f,o,p)}function e(a,b,c,d){return d(c(a.x-b.x),c(a.y-b.y))}function f(a,b,c,d){var e=a.x-b.x,f=a.y-b.y;return d(e*e+f*f)}function g(a,b,c){return c(a.x-b.x)+c(a.y-b.y)}function h(h,i,j,k){var l,m,n,o,p,q,r,s,t,u=h[0].length,v=h.length,w=u*v,x=Math.abs,y=Math.max,z={},A=[],B=[{x:i[0],y:i[1],f:0,g:0,v:i[0]+i[1]*u}],C=1;switch(j={x:j[0],y:j[1],v:j[0]+j[1]*u},k){case"Diagonal":n=a;case"DiagonalFree":m=e;break;case"Euclidean":n=a;case"EuclideanFree":y=Math.sqrt,m=f;break;default:m=g,n=c}n||(n=b);do{for(q=w,r=0,o=0;C>o;++o)(k=B[o].f)<q&&(q=k,r=o);if(s=B.splice(r,1)[0],s.v!=j.v)for(--C,t=d(n,s.x,s.y,h,v,u),o=0,p=t.length;p>o;++o)(l=t[o]).p=s,l.f=l.g=0,l.v=l.x+l.y*u,l.v in z||(l.f=(l.g=s.g+m(l,s,x,y))+m(l,j,x,y),B[C++]=l,z[l.v]=1);else{o=C=0;do A[o++]=[s.x,s.y];while(s=s.p);A.reverse()}}while(C);return A}return h}(),l={offset:{x:0,y:0}};l.init=function(a){$.extend(!0,l,a),n.init("",l.tileWidth,l.tileHeight),l.pathGrid=[];for(var b=0,c=0;c<l.rows;c++){l.pathGrid.push([]);for(var d=0;d<l.columns;d++)l.pathGrid[c].push(!n.tileset[l.data[b]].passable),b++}for(b=0;b<l.actors.length;b++)g.create(l.actors[b]);window.player=Object.create(e).init($.extend({width:32,height:32,colour:"green",speed:5,direction:{x:1,y:0},invulnerable:!0},l.playerStart)),i.clipping||i.resizeCanvas("game",l.tileWidth*l.columns,l.tileHeight*l.rows)},l.load=function(a,b,c,d,e){$.ajax({url:"/maps/"+a+".json",type:"get",success:function(a){l.init(a),"function"==typeof e&&e()},error:function(a,b){console.log("map loading error: "),console.log(b)}})},l.save=function(){$.ajax({url:"/maps/"+l.name+".json",type:"post",data:JSON.stringify(l),success:function(){console.log("map saved")}})},l.render=function(){for(var a=Math.floor,b=Math.ceil,c=a(-l.offset.y/n.tileHeight),d=b((i.gameCanvas.height-l.offset.y)/n.tileHeight),e=a(-l.offset.x/n.tileWidth),f=b((i.gameCanvas.width-l.offset.x)/n.tileWidth),g=c;d>g;g++)for(var h=e;f>h;h++){var j=l.offset.x+h*n.tileWidth,k=l.offset.y+g*n.tileHeight;n.renderTile(l.data[g*l.columns+h],j,k)}},l.position=function(a){l.offset={x:Math.round(i.gameCanvas.width/2)-a.x,y:Math.round(i.gameCanvas.height/2)-a.y},l.offset.x>0&&(l.offset.x=0),l.offset.y>0&&(l.offset.y=0),l.offset.x<i.gameCanvas.width-l.columns*n.tileWidth&&(l.offset.x=i.gameCanvas.width-l.columns*n.tileWidth),l.offset.y<i.gameCanvas.height-l.rows*n.tileHeight&&(l.offset.y=i.gameCanvas.height-l.rows*n.tileHeight)},l.getTileIndex=function(a){var b=Math.floor(a.x/n.tileWidth),c=Math.floor(a.y/n.tileHeight);return c*l.columns+b},l.getTileCentre=function(a){"[object Array]"===Object.prototype.toString.call(a)&&(a=l.getTileFromCoords(a));var b=a%l.columns,c=Math.floor(a/l.columns);return{x:b*n.tileWidth+n.tileWidth/2,y:c*n.tileHeight+n.tileHeight/2}},l.getTileCoords=function(a){return"[object Array]"===Object.prototype.toString.call(a)&&(a=a[0]+a[1]*l.columns),[a%l.columns,Math.floor(a/l.rows)]},l.getTileFromCoords=function(a,b){return"[object Array]"===Object.prototype.toString.call(a)&&(b=a[1],a=a[0]),b*l.columns+a},l.lineTraversable=function(a,b){for(var c,d=p.subtract(a,b),e=p.mag(d),f=p.normalise(d),g=p.clone(a),h=l.getTileIndex(b),i=0;e>i;i++){if(g=p.add(g,f),c=l.getTileIndex(g),c===h)return!0;if(void 0===l.data[c]||!n.tileset[l.data[c]].passable)return!1}return!0},l.highlightTile=function(a){if(i.gameCanvas){var b=l.getTileCentre(a);i.vectors.command(function(){i.gameContext.strokeStyle="white",i.gameContext.strokeRect(Math.round(b.x-n.tileWidth/2)+.5,Math.round(b.y-n.tileHeight/2)+.5,n.tileWidth,n.tileHeight)})}},l.highlightMouseTile=function(){l.highlightTile(l.getTileIndex(j.mouseState))},window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}();var m=Object.create(d);m.entityType="projectile",m.process=function(){this.move()},m.move=function(){var a,b=this;this.x+=this.speed.x*o.coeff,this.y+=this.speed.y*o.coeff,a=l.getTileIndex(this),void 0!==l.data[a]&&n.tileset[l.data[a]].passable||(this.remove=!0),c.instances.forEach(function(a){"projectile"!==a.entityType&&a.entityId!==b.firerId&&a.x-a.halfWidth<b.x&&a.x+a.halfWidth>b.x&&a.y-a.halfHeight<b.y&&a.y+a.halfHeight>b.y&&(b.remove=!0,"function"==typeof a.hit&&a.hit(b))})},m.render=function(){var a=l.offset.x+this.x,b=l.offset.y+this.y;i.gameContext.beginPath(),i.gameContext.arc(a,b,this.halfWidth,0,2*Math.PI),i.gameContext.fillStyle="yellow",i.gameContext.fill()};var n={};n.init=function(a,b,c){n.tileWidth=b,n.tileHeight=c,n.tileset=[{colour:"black",passable:!0},{colour:"blue",passable:!1}]},n.renderTile=function(a,b,c){i.gameContext.fillStyle=n.tileset[a].colour,i.gameContext.fillRect(b,c,n.tileWidth,n.tileHeight)};var o={};o.start=function(a){o.interval=1e3/a,o.time=(new Date).getTime(),o.goalFPS=a,o.FPS=a,o.coeff=1},o.process=function(){var a=(new Date).getTime();o.interval=a-o.time,o.time=a,o.FPS=1e3/o.interval,o.coeff=o.goalFPS/o.FPS};var p={};p.add=function(a,b){return{x:a.x+b.x,y:a.y+b.y}},p.clone=function(a){return p.add(a,{x:0,y:0})},p.subtract=function(a,b){return{x:b.x-a.x,y:b.y-a.y}},p.reverse=function(a){return p.subtract(a,{x:0,y:0})},p.mag=function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},p.distance=function(a,b){return p.mag(p.subtract(a,b))},p.normalise=function(a){var b=p.mag(a)||1;return{x:a.x/b,y:a.y/b}},p.setLength=function(a,b){return a=p.normalise(a),{x:a.x*b,y:a.y*b}},p.dot=function(a,b){return a.x*b.x+a.y*b.y},p.angle=function(a,b,c){if(void 0===b&&(b={x:0,y:-1}),a=p.normalise(a),b=p.normalise(b),c){var d=Math.atan2(a.y,a.x),e=Math.atan2(b.y,b.x);return e-d}return Math.acos(p.dot(a,b))};var q={gun:{projectileSpeed:10,damage:10,reloadTime:100}}}({},function(){return this}());
/*
//@ sourceMappingURL=sourceMap.js
*/