!function(a,b){b["true"]=a,function(a){var b=function(b){var c={};if(b)for(var d in b)c[d]={value:b[d],writable:!0,configurable:!0,enumerable:!0};return a.create(this,c)},c=function(a){for(var b=this.extend(a),c=[],d=1;d<arguments.length;d++)c.push(arguments[d]);return"function"==typeof b.init&&b.init.apply(b,c),b};a.defineProperties(a.prototype,{extend:{value:b},create:{value:c}})}(Object);var c={};c.game=function(){"use strict";var a={mode:"pause"};return a.init=function(){c.graphics.init("fullscreen",""),c.map.load("test","",64,64,a.start)},a.start=function(){a.resume()},a.resume=function(){a.mode="play",c.input.start("play"),c.timer.start(60),a.animationFrame=window.requestAnimationFrame(a.play)},a.play=function(){"play"===a.mode||"over"===a.mode?(c.timer.process(),c.entities.process(),c.map.position(player),"over"===a.mode&&c.graphics.writeText("Game over!",20,30),a.info(),c.graphics.render(),c.input.process(),player.health<=0&&"play"===a.mode&&a.over(),a.animationFrame=window.requestAnimationFrame(a.play)):"pause"===a.mode&&(c.graphics.writeText("Game paused. Press space to resume.",20,30),c.graphics.renderText())},a.info=function(){c.graphics.writeText("FPS: "+Math.round(c.timer.FPS),c.graphics.gameCanvas.width-150,30),c.graphics.writeText("map.offset.x: "+c.map.offset.x,c.graphics.gameCanvas.width-150,50),c.graphics.writeText("map.offset.y: "+c.map.offset.y,c.graphics.gameCanvas.width-150,70),c.graphics.writeText("player.x: "+player.x,c.graphics.gameCanvas.width-150,90),c.graphics.writeText("player.y: "+player.y,c.graphics.gameCanvas.width-150,110),c.graphics.writeText("player.direction.x: "+player.direction.x,c.graphics.gameCanvas.width-150,130),c.graphics.writeText("player.direction.y: "+player.direction.y,c.graphics.gameCanvas.width-150,150),c.graphics.writeText("player.direction angle: "+c.vector.angle(player.direction),c.graphics.gameCanvas.width-200,170),c.graphics.writeText("tile index: "+c.map.getTileIndex(player),c.graphics.gameCanvas.width-150,190)},a.pause=function(){a.mode="pause",c.input.start("pause"),c.graphics.renderText()},a.over=function(){a.mode="over",c.input.start("over")},a.reset=function(){c.entities.instances=[],cancelAnimationFrame(a.animationFrame),a.init()},a.end=function(){a.pause(),c.input.stop()},$(function(){a.init()}),a}(),c.map=function(){"use strict";var a={offset:{x:0,y:0}};return a.init=function(b){$.extend(!0,a,b),c.tiles.init("",a.tileWidth,a.tileHeight),a.pathGrid=[];for(var d=0,e=0;e<a.rows;e++){a.pathGrid.push([]);for(var f=0;f<a.columns;f++)a.pathGrid[e].push(!c.tiles.tileset[a.data[d]].passable),d++}for(d=0;d<a.actors.length;d++)c.actors.create(a.actors[d]);window.player=c.actorPrototype.create($.extend({width:32,height:32,colour:"green",speed:5,direction:{x:1,y:0},invulnerable:!0},a.playerStart)),c.graphics.clipping||c.graphics.resizeCanvas("game",a.tileWidth*a.columns,a.tileHeight*a.rows)},a.load=function(b,c,d,e,f){$.ajax({url:"/maps/"+b+".json",type:"get",success:function(b){a.init(b),"function"==typeof f&&f()},error:function(a,b){console.log("map loading error: "),console.log(b)}})},a.save=function(){$.ajax({url:"/maps/"+a.name+".json",type:"post",data:JSON.stringify(a),success:function(){console.log("map saved")}})},a.render=function(){for(var b=Math.floor,d=Math.ceil,e=b(-a.offset.y/c.tiles.tileHeight),f=d((c.graphics.gameCanvas.height-a.offset.y)/c.tiles.tileHeight),g=b(-a.offset.x/c.tiles.tileWidth),h=d((c.graphics.gameCanvas.width-a.offset.x)/c.tiles.tileWidth),i=e;f>i;i++)for(var j=g;h>j;j++){var k=a.offset.x+j*c.tiles.tileWidth,l=a.offset.y+i*c.tiles.tileHeight;c.tiles.renderTile(a.data[i*a.columns+j],k,l)}},a.checkWithinBounds=function(b){return b.x<0||b.x>a.width||b.y<0||b.y>a.height?!1:!0},a.isPassable=function(b){var d=a.data[b];return void 0===d?!1:c.tiles.tileset[d].passable},a.collisionAdjust=function(b,d){function e(b,d){var e=c.vector.round(c.vector.add(b,d)),f=a.getTileIndex(e);return!a.isPassable(f)}function f(a,b){var c=[],d={topLeft:{x:a.x-a.halfWidth,y:a.y-a.halfHeight},topRight:{x:a.x+a.halfWidth,y:a.y-a.halfHeight},bottomRight:{x:a.x+a.halfWidth,y:a.y+a.halfHeight},bottomLeft:{x:a.x-a.halfWidth,y:a.y+a.halfHeight}};for(var f in d)e(d[f],b)&&c.push(f);return c}function g(a,b,d){var e=Math.sqrt(d.halfWidth*d.halfWidth+d.halfHeight*d.halfHeight),f={topLeft:{x:-1,y:-1},topRight:{x:1,y:-1},bottomRight:{x:1,y:1},bottomLeft:{x:-1,y:1}},g=f[b],h=c.vector.subtract(g,{x:0,y:0});return c.vector.setLength(h,c.vector.mag(h)*e/2)}var h,i,j=c.vector.mag(d),k=[d];d.x&&k.push(c.vector.setLength({x:d.x,y:0},j)),d.y&&k.push(c.vector.setLength({x:0,y:d.y},j)),k.push({x:0,y:0});for(var l=0;l<k.length;l++){if(i=k[l],h=f(b,i),0===h.length)return i;if(1===h.length)return g(i,h[0],b)}},a.position=function(b){a.offset={x:Math.round(c.graphics.gameCanvas.width/2)-b.x,y:Math.round(c.graphics.gameCanvas.height/2)-b.y},a.offset.x>0&&(a.offset.x=0),a.offset.y>0&&(a.offset.y=0),a.offset.x<c.graphics.gameCanvas.width-a.columns*c.tiles.tileWidth&&(a.offset.x=c.graphics.gameCanvas.width-a.columns*c.tiles.tileWidth),a.offset.y<c.graphics.gameCanvas.height-a.rows*c.tiles.tileHeight&&(a.offset.y=c.graphics.gameCanvas.height-a.rows*c.tiles.tileHeight)},a.getTileIndex=function(b){if(a.checkWithinBounds(b)){var d=Math.floor(b.x/c.tiles.tileWidth),e=Math.floor(b.y/c.tiles.tileHeight);return e*a.columns+d}return void 0},a.getTileCentre=function(b){"[object Array]"===Object.prototype.toString.call(b)&&(b=a.getTileFromCoords(b));var d=b%a.columns,e=Math.floor(b/a.columns);return{x:d*c.tiles.tileWidth+c.tiles.tileWidth/2,y:e*c.tiles.tileHeight+c.tiles.tileHeight/2}},a.getTileCoords=function(b){return"[object Array]"===Object.prototype.toString.call(b)&&(b=b[0]+b[1]*a.columns),[b%a.columns,Math.floor(b/a.rows)]},a.getTileFromCoords=function(b,c){return"[object Array]"===Object.prototype.toString.call(b)&&(c=b[1],b=b[0]),c*a.columns+b},a.lineTraversable=function(b,d){for(var e,f=c.vector.subtract(b,d),g=c.vector.mag(f),h=c.vector.normalise(f),i=c.vector.clone(b),j=a.getTileIndex(d),k=0;g>k;k++){if(i=c.vector.add(i,h),e=a.getTileIndex(i),e===j)return!0;if(void 0===a.data[e]||!c.tiles.tileset[a.data[e]].passable)return!1}return!0},a.highlightTile=function(b){if(c.graphics.gameCanvas){var d=a.getTileCentre(b);c.graphics.vectors.command(function(){c.graphics.gameContext.strokeStyle="white",c.graphics.gameContext.strokeRect(Math.round(d.x-c.tiles.tileWidth/2)+.5,Math.round(d.y-c.tiles.tileHeight/2)+.5,c.tiles.tileWidth,c.tiles.tileHeight)})}},a.highlightMouseTile=function(){a.highlightTile(a.getTileIndex(c.input.mouseState))},a}(),c.entities=function(){"use strict";var a={};return a.instances=[],a.process=function(){for(var b=[],c=0;c<a.instances.length;c++)a.instances[c].process(),a.instances[c].remove||b.push(a.instances[c]);a.instances=b},a.render=function(){for(var b=0;b<a.instances.length;b++)a.instances[b].render()},a}(),c.entityPrototype=function(){"use strict";var a={}.extend({hittable:!1,init:function(){if(void 0===a)var a=0;return function(b){return $.extend(this,b),this.entityId=a++,this.halfWidth=this.width/2,this.halfHeight=this.height/2,c.entities.instances.push(this),this}}(),process:function(){}});return a}(),c.actorPrototype=function(){"use strict";var a=c.entityPrototype.extend();return a.entityType="actor",a.hittable=!0,a.health=100,a.weapon="gun",a.move=function(a){var b,d=c.vector,e=!1;return a=d.setLength(a,this.speed*c.timer.coeff),a=c.map.collisionAdjust(this,a),b=c.vector.round(d.add(this,a)),this.direction=d.mag(a)?d.normalise(a):this.direction,this.x===b.x&&this.y===b.y&&(e=!0),this.x=b.x,this.y=b.y,!e},a.moveTowards=function(a){var b=c.vector.subtract(this,a);b=c.vector.setLength(b,this.speed),this.move(b)},a.moveTo=function(a){var b=c.map,e=b.getTileCoords(b.getTileIndex(this)),f=b.getTileCoords(b.getTileIndex(a)),g=d(b.pathGrid,e,f,"Euclidean");g.length>1?this.moveTowards(b.getTileCentre(g[1])):1===g.length&&this.moveTowards(b.getTileCentre(g[0]))},a.hit=function(a){this.invulnerable||(this.health-=a.damage,this.health<=0&&(this.remove=!0)),"function"==typeof this.hitHandler&&this.hitHandler(a)},a.fire=function(a){var b,d=c.weapons[this.weapon],e=d.projectileSpeed,f=c.vector.subtract(this,a),g=c.vector.setLength(f,e),h=this;(void 0===this.lastFired||this.lastFired<c.timer.time-d.reloadTime)&&(b=c.projectilePrototype.create({x:this.x,y:this.y,width:4,height:4,colour:"yellow",speed:g,firerId:h.entityId,damage:d.damage}),this.lastFired=c.timer.time),this.direction=c.vector.normalise(f)},a.render=function(){c.graphics.gameContext.save(),c.graphics.gameContext.translate(c.map.offset.x,c.map.offset.y),c.graphics.gameContext.translate(this.x,this.y),c.graphics.gameContext.rotate(-c.vector.angle(this.direction,{x:0,y:-1},!0)),c.graphics.gameContext.beginPath(),c.graphics.gameContext.moveTo(-this.halfWidth,this.halfHeight),c.graphics.gameContext.lineTo(0,-this.halfHeight),c.graphics.gameContext.lineTo(this.halfWidth,this.halfHeight),c.graphics.gameContext.fillStyle=this.colour,c.graphics.gameContext.fill(),c.graphics.gameContext.restore(),c.graphics.writeText(this.health,this.x-this.halfWidth+c.map.offset.x,this.y+c.map.offset.y)},a}(),c.baddyPrototype=function(){"use strict";var a=c.actorPrototype.extend();return a.firerId=function(){var a=-1;return function(){return a++}()}(),a.target={x:0,y:0},a.process=function(){var a,b;if(player.health<=0)this.mode="watch";else switch(this.baddySeePlayer()&&(this.targetTile=c.map.getTileIndex(player),this.target=$.extend({},player,c.map.getTileCentre(this.targetTile)),this.target.direction=c.vector.clone(player.direction),this.fire(player),this.mode=this.targetDistance>this.idealRange?"chase":"attack"),this.mode){case"watch":break;case"attack":this.direction=c.vector.subtract(this,this.target),player.health>0&&!this.baddySeePlayer()&&(this.mode="chase");break;case"chase":a=c.vector.distance(this,this.target),a<this.speed?(this.x=this.target.x,this.y=this.target.y,this.mode="search",this.direction=this.target.direction):this.moveTo(this.target);break;case"search":b=c.vector.setLength(this.direction,this.speed),this.move(b)||(this.mode="returnToStation");break;case"returnToStation":a=c.vector.distance(this,this.initial),a<this.speed?(this.x=this.initial.x,this.y=this.initial.y,this.mode="watch",this.direction=this.initial.direction):this.moveTo(this.initial)}},a.hitHandler=function(a){this.direction=c.vector.reverse(a.speed)},a.baddySeePlayer=function(){var a=c.vector.subtract(this,player);return c.vector.mag(a)>this.maxRange||c.vector.dot(this.direction,a)<0?!1:c.map.lineTraversable(this,player)},a}(),c.actors=function(){"use strict";return{create:function(a){var b=this[a.type];$.extend(b,a),b.initial=$.extend({},b),c[b.prototype].create(b)},player:{prototype:"actorPrototype",width:32,height:32,colour:"green",speed:5,direction:{x:1,y:0},invulnerable:!1},baddy:{prototype:"baddyPrototype",width:32,height:32,colour:"red",maxRange:500,mode:"watch",idealRange:500,speed:5,direction:{x:1,y:0}}}}(),c.graphics=function(){"use strict";var a={};return a.init=function(b,c,d){$("#gameContainer").html(""),a.viewport={width:$("#gameContainer").width(),height:$("#gameContainer").height()},"fullscreen"===b&&(a.fullscreen=!0,b=a.viewport.width,c=a.viewport.height),a.initCanvas("game",b,c),a.clipping=void 0===d?!0:d},a.initCanvas=function(b,c,d){c||(c=800),d||(d=600),$("#gameContainer").append('<canvas id="'+b+'Canvas" class="defaultBorder" width="'+c+'px" height="'+d+'px">Your broswer does not support the "canvas element". To play this game you will need a more modern browser.</canvas>'),$("#"+b+"Canvas").css({width:+c+"px",height:d+"px"}),a[b+"Canvas"]=document.getElementById(b+"Canvas"),a[b+"Context"]=a.gameCanvas.getContext("2d"),a[b+"Canvas"].width=c,a[b+"Canvas"].height=d},a.textQueue=[],a.writeText=function(b,c,d){a.textQueue.push({string:b,x:c,y:d})},a.writeTextNow=function(b,c,d){var e=a.gameContext.fillStyle,f=a.gameContext.strokeStyle,g=a.gameContext.font;a.gameContext.fillStyle="white",a.gameContext.strokeStyle="black",a.gameContext.font="12pt Arial",a.gameContext.strokeText(b,c,d),a.gameContext.fillText(b,c,d),a.gameContext.fillStyle=e,a.gameContext.strokeStyle=f,a.gameContext.font=g},a.renderText=function(){a.textQueue.forEach(function(b){a.writeTextNow(b.string,b.x,b.y)}),a.textQueue=[]},a.vectors={commands:[],render:function(){for(var a=0;a<this.commands.length;a++)this.commands[a]();this.commands=[]},command:function(a){this.commands.push(a)}},a.render=function(){a.clipping?a.gameContext.clearRect(-c.map.offset.x,-c.map.offset.y,a.gameCanvas.width,a.gameCanvas.height):a.gameContext.clearRect(-c.map.offset.x,-c.map.offset.y,a.viewport.width,a.viewport.height),c.map.render(),c.entities.render(),a.vectors.render(),a.renderText()},a.resizeCanvas=function(b,c,d){a[b+"Canvas"].width=c,a[b+"Canvas"].height=d,$("#"+b+"Canvas").css({width:+c+"px",height:d+"px"})},a}(),c.input=function(){"use strict";var a={};return a.keyMap={80:"pause",27:"quit",65:"left",87:"up",68:"right",83:"down",73:"invulnerable"},a.start=function(b){switch($(document).off(),b){case"play":a.keyState={pause:0,quit:0,left:0,up:0,right:0,down:0},$(document).on("keydown keyup",function(b){var c=""+b.which;return void 0!==a.keyMap[c]?("invulnerable"===a.keyMap[c]&&"keydown"===b.type&&(player.invulnerable=!player.invulnerable),a.keyState[a.keyMap[c]]="keydown"===b.type?1:0,!1):void 0}),a.mouseState={left:0,middle:0,right:0,x:0,y:0},$(document).on("mousedown mouseup",function(b){switch(b.which){case 1:a.mouseState.left="mousedown"===b.type?1:0;break;case 2:a.mouseState.middle="mousedown"===b.type?1:0;break;case 3:a.mouseState.right="mousedown"===b.type?1:0}}),$(document).on("mousemove",function(b){var c=$("#gameCanvas").offset();a.mouseState.x=b.pageX-c.left,a.mouseState.y=b.pageY-c.top});break;case"pause":$(document).off(),$(document).on("keydown",function(a){return 32===a.which&&c.game.resume(),!1});break;case"over":$(document).off(),$(document).on("keydown",function(a){return 32===a.which&&c.game.reset(),!1});break;case"edit":a.mouseState={left:0,middle:0,right:0,x:0,y:0},$(document).on("mousemove",function(b){var d=$("#gameCanvas").offset();a.mouseState.x=b.pageX-d.left,a.mouseState.y=b.pageY-d.top,c.game.update=!0})}},a.process=function(){switch(c.game.mode){case"play":a.keyState.pause&&c.game.pause(),a.keyState.quit&&(c.game.end(),c.graphics.writeText("Game ended.",20,30));var b=0,d=0;a.keyState.left&&(b+=-5),a.keyState.up&&(d+=-5),a.keyState.right&&(b+=5),a.keyState.down&&(d+=5),(0!==b||0!==d)&&player.move({x:b,y:d}),a.mouseState.left&&player.fire({x:a.mouseState.x-c.map.offset.x,y:a.mouseState.y-c.map.offset.y});break;case"edit":}},a.stop=function(){$(document).off()},a}();var d=function(){function a(a,b,c,d,e,f,g,h,i,j,k,l,m){return a&&(c&&!i[e][g]&&(l[m++]={x:g,y:e}),d&&!i[e][h]&&(l[m++]={x:h,y:e})),b&&(c&&!i[f][g]&&(l[m++]={x:g,y:f}),d&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function b(a,b,c,d,e,f,g,h,i,j,k,l,m){return a=e>-1,b=j>f,c=k>g,d=h>-1,c&&(a&&!i[e][g]&&(l[m++]={x:g,y:e}),b&&!i[f][g]&&(l[m++]={x:g,y:f})),d&&(a&&!i[e][h]&&(l[m++]={x:h,y:e}),b&&!i[f][h]&&(l[m++]={x:h,y:f})),l}function c(a,b,c,d,e,f,g,h,i,j,k,l){return l}function d(a,b,c,d,e,f){var g=c-1,h=c+1,i=b+1,j=b-1,k=g>-1&&!d[g][b],l=e>h&&!d[h][b],m=f>i&&!d[c][i],n=j>-1&&!d[c][j],o=[],p=0;return k&&(o[p++]={x:b,y:g}),m&&(o[p++]={x:i,y:c}),l&&(o[p++]={x:b,y:h}),n&&(o[p++]={x:j,y:c}),a(k,l,m,n,g,h,i,j,d,e,f,o,p)}function e(a,b,c,d){return d(c(a.x-b.x),c(a.y-b.y))}function f(a,b,c,d){var e=a.x-b.x,f=a.y-b.y;return d(e*e+f*f)}function g(a,b,c){return c(a.x-b.x)+c(a.y-b.y)}function h(h,i,j,k){var l,m,n,o,p,q,r,s,t,u=h[0].length,v=h.length,w=u*v,x=Math.abs,y=Math.max,z={},A=[],B=[{x:i[0],y:i[1],f:0,g:0,v:i[0]+i[1]*u}],C=1;switch(j={x:j[0],y:j[1],v:j[0]+j[1]*u},k){case"Diagonal":n=a;case"DiagonalFree":m=e;break;case"Euclidean":n=a;case"EuclideanFree":y=Math.sqrt,m=f;break;default:m=g,n=c}n||(n=b);do{for(q=w,r=0,o=0;C>o;++o)(k=B[o].f)<q&&(q=k,r=o);if(s=B.splice(r,1)[0],s.v!=j.v)for(--C,t=d(n,s.x,s.y,h,v,u),o=0,p=t.length;p>o;++o)(l=t[o]).p=s,l.f=l.g=0,l.v=l.x+l.y*u,l.v in z||(l.f=(l.g=s.g+m(l,s,x,y))+m(l,j,x,y),B[C++]=l,z[l.v]=1);else{o=C=0;do A[o++]=[s.x,s.y];while(s=s.p);A.reverse()}}while(C);return A}return h}();window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),c.projectilePrototype=function(){"use strict";var a=c.entityPrototype.extend();return a.entityType="projectile",a.process=function(){this.move()},a.move=function(){var a,b=this;this.x+=this.speed.x*c.timer.coeff,this.y+=this.speed.y*c.timer.coeff,a=c.map.getTileIndex(this),void 0!==c.map.data[a]&&c.tiles.tileset[c.map.data[a]].passable||(this.remove=!0),c.entities.instances.forEach(function(a){"projectile"!==a.entityType&&a.entityId!==b.firerId&&a.x-a.halfWidth<b.x&&a.x+a.halfWidth>b.x&&a.y-a.halfHeight<b.y&&a.y+a.halfHeight>b.y&&(b.remove=!0,"function"==typeof a.hit&&a.hit(b))})},a.render=function(){var a=c.map.offset.x+this.x,b=c.map.offset.y+this.y;c.graphics.gameContext.beginPath(),c.graphics.gameContext.arc(a,b,this.halfWidth,0,2*Math.PI),c.graphics.gameContext.fillStyle="yellow",c.graphics.gameContext.fill()},a}(),c.tiles=function(){"use strict";var a={};return a.init=function(b,c,d){a.tileWidth=c,a.tileHeight=d,a.tileset=[{colour:"black",passable:!0},{colour:"blue",passable:!1}]},a.renderTile=function(b,d,e){c.graphics.gameContext.fillStyle=a.tileset[b].colour,c.graphics.gameContext.fillRect(d,e,a.tileWidth,a.tileHeight)},a}(),c.timer=function(){"use strict";var a={};return a.start=function(b){a.interval=1e3/b,a.time=(new Date).getTime(),a.goalFPS=b,a.FPS=b,a.coeff=1},a.process=function(){var b=(new Date).getTime();a.interval=b-a.time,a.time=b,a.FPS=1e3/a.interval,a.coeff=a.goalFPS/a.FPS},a}(),c.util=function(){"use strict";return{valFromString:function(a){for(var b=window,c=a.split("."),d=0;d<c.length;d++)b=b[c[d]];return b}}}(),c.vector=function(){"use strict";var a={};return a.round=function(a){return{x:Math.round(a.x),y:Math.round(a.y)}},a.add=function(a,b){return{x:a.x+b.x,y:a.y+b.y}},a.clone=function(b){return a.add(b,{x:0,y:0})},a.subtract=function(a,b){return{x:b.x-a.x,y:b.y-a.y}},a.reverse=function(b){return a.subtract(b,{x:0,y:0})},a.mag=function(a){return Math.sqrt(a.x*a.x+a.y*a.y)},a.distance=function(b,c){return a.mag(a.subtract(b,c))},a.normalise=function(b){var c=a.mag(b)||1;return{x:b.x/c,y:b.y/c}},a.setLength=function(b,c){return b=a.normalise(b),{x:b.x*c,y:b.y*c}},a.dot=function(a,b){return a.x*b.x+a.y*b.y},a.angle=function(b,c,d){if(void 0===c&&(c={x:0,y:-1}),b=a.normalise(b),c=a.normalise(c),d){var e=Math.atan2(b.y,b.x),f=Math.atan2(c.y,c.x);return f-e}return Math.acos(a.dot(b,c))},a}(),c.weapons=function(){"use strict";return{gun:{projectileSpeed:10,damage:10,reloadTime:100}}}()}({},function(){return this}());
/*
//@ sourceMappingURL=sourceMap.js
*/